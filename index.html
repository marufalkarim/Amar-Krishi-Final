<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶ï‡ßÉ‡¶∑‡¶ø - Reduce Food Loss in Bangladesh</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        /* Design System Variables */
        :root {
            --color-primary: #208C9E;
            --color-primary-hover: #1a7080;
            --color-primary-active: #155a66;
            --color-secondary: #FEF5E7;
            --color-accent: #E68161;
            --color-error: #C0152F;
            --color-success: #15803D;
            --color-warning: #F59E0B;
            --color-neutral: #6B6C7D;
            --color-bg: #FAFAFA;
            --color-surface: #FFFFFF;
            --color-text: #1F2937;
            --color-text-secondary: #6B7280;
            --color-border: #E5E7EB;
            
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Noto Sans Bengali', sans-serif;
            --transition: 250ms cubic-bezier(0.16, 1, 0.3, 1);
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --radius: 12px;
            --radius-sm: 8px;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --color-bg: #111827;
                --color-surface: #1F2937;
                --color-text: #F9FAFB;
                --color-text-secondary: #D1D5DB;
                --color-border: #374151;
            }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            background: var(--color-bg);
            color: var(--color-text);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }

        /* Utility Classes */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .hidden {
            display: none !important;
        }

        /* Button Styles */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 12px 24px;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition);
            min-height: 44px;
            gap: 8px;
        }

        .btn-primary {
            background: var(--color-primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--color-primary-hover);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-secondary {
            background: var(--color-secondary);
            color: var(--color-text);
            border: 2px solid var(--color-border);
        }

        .btn-secondary:hover {
            background: var(--color-border);
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--color-text);
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--color-border);
            border-radius: var(--radius-sm);
            font-size: 16px;
            transition: all var(--transition);
            background: var(--color-surface);
            color: var(--color-text);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(32, 140, 158, 0.1);
        }

        /* Card Styles */
        .card {
            background: var(--color-surface);
            border-radius: var(--radius);
            padding: 24px;
            box-shadow: var(--shadow-md);
            transition: all var(--transition);
        }

        .card:hover {
            box-shadow: var(--shadow-lg);
        }

        /* Landing Page */
        #landing-page {
            min-height: 100vh;
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-accent) 100%);
            color: white;
            position: relative;
            overflow: hidden;
        }

        .landing-header {
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .lang-toggle {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid white;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            transition: all var(--transition);
        }

        .lang-toggle:hover {
            background: white;
            color: var(--color-primary);
        }

        .lang-toggle-app {
            background: var(--color-primary);
            border: 2px solid var(--color-primary);
            color: white;
            padding: 10px 18px;
            border-radius: 20px;
            cursor: pointer;
            transition: all var(--transition);
            font-weight: 600;
            font-size: 14px;
        }

        .lang-toggle-app:hover {
            background: var(--color-primary-hover);
            border-color: var(--color-primary-hover);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .hero {
            text-align: center;
            padding: 60px 20px;
            position: relative;
            z-index: 1;
        }

        .hero h1 {
            font-size: clamp(32px, 8vw, 56px);
            margin-bottom: 20px;
            animation: fadeInUp 0.8s ease-out;
        }

        .hero p {
            font-size: clamp(18px, 4vw, 24px);
            margin-bottom: 40px;
            opacity: 0.95;
            animation: fadeInUp 0.8s ease-out 0.2s backwards;
        }

        .problem-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 60px auto;
            max-width: 1000px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: var(--radius);
            border: 2px solid rgba(255, 255, 255, 0.2);
            animation: fadeInUp 0.8s ease-out;
        }

        .stat-number {
            font-size: 48px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 18px;
            opacity: 0.9;
        }

        .workflow {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin: 60px auto;
            flex-wrap: wrap;
            max-width: 900px;
        }

        .workflow-step {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            padding: 24px;
            border-radius: var(--radius);
            border: 2px solid rgba(255, 255, 255, 0.3);
            text-align: center;
            flex: 1;
            min-width: 150px;
            animation: scaleIn 0.6s ease-out;
        }

        .workflow-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .workflow-arrow {
            font-size: 32px;
            animation: pulse 2s ease-in-out infinite;
        }

        /* Animations */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.2);
            }
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
            }
            to {
                transform: translateX(0);
            }
        }

        /* App Container */
        #app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: var(--color-surface);
            border-right: 1px solid var(--color-border);
            padding: 20px;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            transition: all var(--transition);
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--color-border);
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            margin-bottom: 8px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all var(--transition);
            color: var(--color-text);
            text-decoration: none;
        }

        .nav-item:hover, .nav-item.active {
            background: var(--color-primary);
            color: white;
        }

        .nav-icon {
            font-size: 20px;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 30px;
            background: var(--color-bg);
        }

        .page-header {
            margin-bottom: 30px;
        }

        .page-title {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .page-subtitle {
            color: var(--color-text-secondary);
            font-size: 16px;
        }

        /* Dashboard */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-box {
            background: var(--color-surface);
            padding: 24px;
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
            border-left: 4px solid var(--color-primary);
        }

        .stat-box-icon {
            font-size: 32px;
            margin-bottom: 12px;
        }

        .stat-box-value {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 4px;
        }

        .stat-box-label {
            color: var(--color-text-secondary);
            font-size: 14px;
        }

        /* Batch List */
        .batch-list {
            display: grid;
            gap: 16px;
        }

        .batch-item {
            background: var(--color-surface);
            padding: 20px;
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all var(--transition);
        }

        .batch-item:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .batch-info {
            flex: 1;
        }

        .batch-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .batch-details {
            color: var(--color-text-secondary);
            font-size: 14px;
        }

        .risk-badge {
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .risk-low {
            background: rgba(21, 128, 61, 0.1);
            color: var(--color-success);
        }

        .risk-medium {
            background: rgba(245, 158, 11, 0.1);
            color: var(--color-warning);
        }

        .risk-high {
            background: rgba(192, 21, 47, 0.1);
            color: var(--color-error);
        }

        /* Weather */
        .weather-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 30px;
        }

        .weather-card {
            background: var(--color-surface);
            padding: 20px;
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
            text-align: center;
        }

        .weather-date {
            font-weight: 600;
            margin-bottom: 12px;
        }

        .weather-icon {
            font-size: 48px;
            margin: 12px 0;
        }

        .weather-temp {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 8px;
        }

        /* Map */
        #risk-map {
            height: 500px;
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow-md);
        }

        /* Alert Box */
        .alert {
            padding: 16px 20px;
            border-radius: var(--radius-sm);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideInRight 0.5s ease-out;
        }

        .alert-warning {
            background: rgba(245, 158, 11, 0.1);
            border-left: 4px solid var(--color-warning);
            color: var(--color-warning);
        }

        .alert-danger {
            background: rgba(192, 21, 47, 0.1);
            border-left: 4px solid var(--color-error);
            color: var(--color-error);
        }

        .alert-success {
            background: rgba(21, 128, 61, 0.1);
            border-left: 4px solid var(--color-success);
            color: var(--color-success);
        }

        /* Image Upload */
        .upload-area {
            border: 2px dashed var(--color-border);
            border-radius: var(--radius);
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all var(--transition);
        }

        .upload-area:hover {
            border-color: var(--color-primary);
            background: rgba(32, 140, 158, 0.05);
        }

        .upload-area.dragover {
            border-color: var(--color-primary);
            background: rgba(32, 140, 158, 0.1);
        }

        .image-preview {
            max-width: 100%;
            max-height: 400px;
            border-radius: var(--radius);
            margin: 20px auto;
            display: block;
        }

        /* Voice Interface */
        .voice-container {
            text-align: center;
            padding: 40px;
        }

        .voice-button {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: var(--color-primary);
            color: white;
            border: none;
            font-size: 48px;
            cursor: pointer;
            transition: all var(--transition);
            box-shadow: var(--shadow-lg);
        }

        .voice-button:hover {
            transform: scale(1.1);
        }

        .voice-button.listening {
            animation: pulse 1.5s ease-in-out infinite;
            background: var(--color-error);
        }

        .chat-messages {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 30px;
            padding: 20px;
            background: var(--color-surface);
            border-radius: var(--radius);
        }

        .message {
            margin-bottom: 16px;
            padding: 12px 16px;
            border-radius: var(--radius-sm);
            max-width: 80%;
        }

        .message-user {
            background: var(--color-primary);
            color: white;
            margin-left: auto;
        }

        .message-bot {
            background: var(--color-secondary);
            color: var(--color-text);
        }

        /* Badges */
        .badges-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 20px;
        }

        .badge-card {
            background: var(--color-surface);
            padding: 24px;
            border-radius: var(--radius);
            text-align: center;
            box-shadow: var(--shadow-sm);
            transition: all var(--transition);
        }

        .badge-card.unlocked {
            border: 2px solid var(--color-success);
        }

        .badge-card.locked {
            opacity: 0.5;
        }

        .badge-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .badge-name {
            font-weight: 600;
            font-size: 14px;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: var(--color-surface);
            padding: 16px 24px;
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            animation: slideInRight 0.3s ease-out;
            z-index: 1000;
            border-left: 4px solid var(--color-success);
        }

        /* Loading Spinner */
        .spinner {
            border: 3px solid var(--color-border);
            border-top: 3px solid var(--color-primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
            }

            .main-content {
                margin-left: 0;
            }

            .workflow {
                flex-direction: column;
            }

            .workflow-arrow {
                transform: rotate(90deg);
            }
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: var(--color-surface);
            padding: 30px;
            border-radius: var(--radius);
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <!-- Landing Page -->
    <div id="landing-page">
        <div class="landing-header">
            <div class="logo">üåæ ‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶ï‡ßÉ‡¶∑‡¶ø</div>
            <button class="lang-toggle" onclick="toggleLanguage()">üåê <span id="lang-text">‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ</span></button>
        </div>

        <div class="hero container">
            <h1 id="hero-title">Save Bangladesh's Food. Save Our Future.</h1>
            <p id="hero-subtitle">Technology-powered solution to reduce food loss and empower farmers</p>
            <button class="btn btn-primary" onclick="showAuthModal('register')" style="font-size: 18px; padding: 16px 32px;">
                <span id="cta-text">Start Protecting Your Harvest</span> ‚Üí
            </button>
        </div>

        <div class="problem-stats container">
            <div class="stat-card" style="animation-delay: 0.1s">
                <div class="stat-number">4.5M</div>
                <div class="stat-label" id="stat1">Metric Tonnes of Food Lost Annually</div>
            </div>
            <div class="stat-card" style="animation-delay: 0.2s">
                <div class="stat-number">$1.5B</div>
                <div class="stat-label" id="stat2">Economic Cost Every Year</div>
            </div>
            <div class="stat-card" style="animation-delay: 0.3s">
                <div class="stat-number">12-32%</div>
                <div class="stat-label" id="stat3">Staple Foods Lost in Supply Chain</div>
            </div>
        </div>

        <div class="workflow container">
            <div class="workflow-step">
                <div class="workflow-icon">üìä</div>
                <div id="workflow1">Collect Data</div>
            </div>
            <div class="workflow-arrow">‚Üí</div>
            <div class="workflow-step">
                <div class="workflow-icon">‚ö†Ô∏è</div>
                <div id="workflow2">Smart Warning</div>
            </div>
            <div class="workflow-arrow">‚Üí</div>
            <div class="workflow-step">
                <div class="workflow-icon">‚úÖ</div>
                <div id="workflow3">Take Action</div>
            </div>
            <div class="workflow-arrow">‚Üí</div>
            <div class="workflow-step">
                <div class="workflow-icon">üåæ</div>
                <div id="workflow4">Save Food</div>
            </div>
        </div>
    </div>

    <!-- App Container -->
    <div id="app-container" class="hidden">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <span style="font-size: 24px;">üåæ</span>
                <div>
                    <div style="font-weight: bold; font-size: 18px;">‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶ï‡ßÉ‡¶∑‡¶ø</div>
                    <div style="font-size: 12px; color: var(--color-text-secondary);" id="user-name"></div>
                </div>
                <button class="lang-toggle-app" onclick="toggleLanguage()" title="Toggle Language" style="margin-left: auto; width: auto;">
                    üåê <span id="lang-toggle-app">EN</span>
                </button>
            </div>
            <nav>
                <div class="nav-item active" onclick="showPage('dashboard')">
                    <span class="nav-icon">üè†</span>
                    <span class="nav-text" id="nav-dashboard">Dashboard</span>
                </div>
                <div class="nav-item" onclick="showPage('add-batch')">
                    <span class="nav-icon">‚ûï</span>
                    <span class="nav-text" id="nav-add-batch">Add Crop Batch</span>
                </div>
                <div class="nav-item" onclick="showPage('weather')">
                    <span class="nav-icon">üå§Ô∏è</span>
                    <span class="nav-text" id="nav-weather">Weather</span>
                </div>
                <div class="nav-item" onclick="showPage('scanner')">
                    <span class="nav-icon">üì∑</span>
                    <span class="nav-text" id="nav-scanner">Crop Scanner</span>
                </div>
                <div class="nav-item" onclick="showPage('pest')">
                    <span class="nav-icon">üîç</span>
                    <span class="nav-text" id="nav-pest">Pest ID</span>
                </div>
                <div class="nav-item" onclick="showPage('map')">
                    <span class="nav-icon">üó∫Ô∏è</span>
                    <span class="nav-text" id="nav-map">Risk Map</span>
                </div>
                <div class="nav-item" onclick="showPage('voice')">
                    <span class="nav-icon">üé§</span>
                    <span class="nav-text" id="nav-voice">Voice Assistant</span>
                </div>
                <div class="nav-item" onclick="showPage('profile')">
                    <span class="nav-icon">üë§</span>
                    <span class="nav-text" id="nav-profile">Profile</span>
                </div>
                <div class="nav-item" onclick="logout()" style="margin-top: 20px; border-top: 1px solid var(--color-border); padding-top: 20px;">
                    <span class="nav-icon">üö™</span>
                    <span class="nav-text" id="nav-logout">Logout</span>
                </div>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Dashboard Page -->
            <div id="page-dashboard" class="page">
                <div class="page-header">
                    <h1 class="page-title" id="dashboard-title">Dashboard</h1>
                    <p class="page-subtitle" id="dashboard-subtitle">Overview of your crops and alerts</p>
                </div>

                <div id="alerts-container"></div>

                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-box-icon">üì¶</div>
                        <div class="stat-box-value" id="total-batches">0</div>
                        <div class="stat-box-label" id="stat-batches">Active Batches</div>
                    </div>
                    <div class="stat-box" style="border-left-color: var(--color-warning);">
                        <div class="stat-box-icon">‚ö†Ô∏è</div>
                        <div class="stat-box-value" id="at-risk-batches">0</div>
                        <div class="stat-box-label" id="stat-risk">At Risk</div>
                    </div>
                    <div class="stat-box" style="border-left-color: var(--color-success);">
                        <div class="stat-box-icon">‚úÖ</div>
                        <div class="stat-box-value" id="interventions">0</div>
                        <div class="stat-box-label" id="stat-interventions">Interventions</div>
                    </div>
                    <div class="stat-box" style="border-left-color: var(--color-accent);">
                        <div class="stat-box-icon">üèÜ</div>
                        <div class="stat-box-value" id="badges-earned">0</div>
                        <div class="stat-box-label" id="stat-badges">Badges Earned</div>
                    </div>
                </div>

                <div class="card">
                    <h2 style="margin-bottom: 20px;" id="batches-title">Your Crop Batches</h2>
                    <div class="batch-list" id="batch-list"></div>
                </div>
            </div>

            <!-- Add Batch Page -->
            <div id="page-add-batch" class="page hidden">
                <div class="page-header">
                    <h1 class="page-title" id="add-batch-title">Register New Crop Batch</h1>
                    <p class="page-subtitle" id="add-batch-subtitle">Add your harvested crops for monitoring</p>
                </div>

                <div class="card">
                    <form id="batch-form" onsubmit="submitBatch(event)">
                        <div class="form-group">
                            <label class="form-label" id="label-crop">Crop Type</label>
                            <select class="form-control" id="crop-type" required>
                                <option value="Paddy/Rice">üåæ Paddy/Rice (‡¶ß‡¶æ‡¶®)</option>
                                <option value="Wheat">üåæ Wheat (‡¶ó‡¶Æ)</option>
                                <option value="Maize">üåΩ Maize (‡¶≠‡ßÅ‡¶ü‡ßç‡¶ü‡¶æ)</option>
                                <option value="Potato">ü•î Potato (‡¶Ü‡¶≤‡ßÅ)</option>
                                <option value="Tomato">üçÖ Tomato (‡¶ü‡¶Æ‡ßá‡¶ü‡ßã)</option>
                                <option value="Onion">üßÖ Onion (‡¶™‡ßá‡¶Å‡¶Ø‡¶º‡¶æ‡¶ú)</option>
                                <option value="Garlic">üßÑ Garlic (‡¶∞‡¶∏‡ßÅ‡¶®)</option>
                                <option value="Cabbage">ü•¨ Cabbage (‡¶¨‡¶æ‡¶Å‡¶ß‡¶æ‡¶ï‡¶™‡¶ø)</option>
                                <option value="Carrot">ü•ï Carrot (‡¶ó‡¶æ‡¶ú‡¶∞)</option>
                                <option value="Spinach">ü•¨ Spinach (‡¶™‡¶æ‡¶≤‡¶Ç ‡¶∂‡¶æ‡¶ï)</option>
                                <option value="Beans">ü´ò Beans (‡¶¨‡¶ø‡¶®)</option>
                                <option value="Peas">ü´õ Peas (‡¶Æ‡¶ü‡¶∞)</option>
                                <option value="Cucumber">ü•í Cucumber (‡¶∂‡¶∏‡¶æ)</option>
                                <option value="Eggplant">üçÜ Eggplant (‡¶¨‡ßá‡¶ó‡ßÅ‡¶®)</option>
                                <option value="Chili">üå∂Ô∏è Chili (‡¶Æ‡¶∞‡¶ø‡¶ö)</option>
                                <option value="Jute">üåø Jute (‡¶™‡¶æ‡¶ü)</option>
                                <option value="Sugarcane">üéã Sugarcane (‡¶Ü‡¶ñ)</option>
                                <option value="Tea Leaf">üçµ Tea Leaf (‡¶ö‡¶æ ‡¶™‡¶æ‡¶§‡¶æ)</option>
                                <option value="Coconut">ü•• Coconut (‡¶®‡¶æ‡¶∞‡¶ï‡ßá‡¶≤)</option>
                                <option value="Banana">üçå Banana (‡¶ï‡¶≤‡¶æ)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label" id="label-weight">Weight (kg)</label>
                            <input type="number" class="form-control" id="crop-weight" min="1" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" id="label-harvest">Harvest Date</label>
                            <input type="date" class="form-control" id="harvest-date" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" id="label-location">Storage Location</label>
                            <select class="form-control" id="storage-location" required>
                                <option value="Dhaka" data-i18n="loc-Dhaka">Dhaka</option>
                                <option value="Narayanganj" data-i18n="loc-Narayanganj">Narayanganj</option>
                                <option value="Gazipur" data-i18n="loc-Gazipur">Gazipur</option>
                                <option value="Sylhet" data-i18n="loc-Sylhet">Sylhet</option>
                                <option value="Chittagong" data-i18n="loc-Chittagong">Chittagong</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label" id="label-storage">Storage Type</label>
                            <select class="form-control" id="storage-type" required>
                                <option value="Jute Bag Stack" data-i18n="storage-jute">Jute Bag Stack (‡¶™‡¶æ‡¶ü‡ßá‡¶∞ ‡¶¨‡ßã‡¶∞‡¶æ‡¶Ø‡¶º ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ï)</option>
                                <option value="Silo" data-i18n="storage-silo">Silo (‡¶∏‡¶æ‡¶á‡¶≤‡ßã)</option>
                                <option value="Open Area" data-i18n="storage-open">Open Area (‡¶ñ‡ßã‡¶≤‡¶æ ‡¶∏‡ßç‡¶•‡¶æ‡¶®‡ßá)</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary" style="width: 100%;" id="btn-submit">Register Batch</button>
                    </form>
                </div>
            </div>

            <!-- Weather Page -->
            <div id="page-weather" class="page hidden">
                <div class="page-header">
                    <h1 class="page-title" id="weather-title">Weather Forecast</h1>
                    <p class="page-subtitle" id="weather-subtitle">5-day weather outlook for your location</p>
                </div>

                <div id="weather-alerts"></div>

                <div class="weather-grid" id="weather-grid">
                    <div class="spinner"></div>
                </div>
            </div>

            <!-- Scanner Page -->
            <div id="page-scanner" class="page hidden">
                <div class="page-header">
                    <h1 class="page-title" id="scanner-title">Crop Health Scanner</h1>
                    <p class="page-subtitle" id="scanner-subtitle">Upload a photo to check crop freshness</p>
                </div>

                <div class="card">
                    <div class="upload-area" id="scanner-upload" onclick="document.getElementById('scanner-file').click()">
                        <div style="font-size: 64px; margin-bottom: 16px;">üì∏</div>
                        <div style="font-size: 18px; margin-bottom: 8px;" id="scanner-upload-text">Click or drag to upload crop photo</div>
                        <div style="color: var(--color-text-secondary);" id="scanner-formats">Supports: JPG, PNG</div>
                        <input type="file" id="scanner-file" accept="image/*" style="display: none;" onchange="handleScannerUpload(event)">
                    </div>
                    <div id="scanner-preview" class="hidden">
                        <img id="scanner-image" class="image-preview" />
                    </div>
                    <div id="scanner-result" class="hidden" style="margin-top: 20px;"></div>
                </div>
            </div>

            <!-- Pest ID Page -->
            <div id="page-pest" class="page hidden">
                <div class="page-header">
                    <h1 class="page-title" id="pest-title">Pest Identification</h1>
                    <p class="page-subtitle" id="pest-subtitle">AI-powered pest detection and treatment recommendations</p>
                </div>

                <div class="card">
                    <div class="upload-area" id="pest-upload" onclick="document.getElementById('pest-file').click()">
                        <div style="font-size: 64px; margin-bottom: 16px;">üîç</div>
                        <div style="font-size: 18px; margin-bottom: 8px;" id="pest-upload-text">Upload pest or damage photo</div>
                        <div style="color: var(--color-text-secondary);" id="pest-formats">Supports: JPG, PNG</div>
                        <input type="file" id="pest-file" accept="image/*" style="display: none;" onchange="handlePestUpload(event)">
                    </div>
                    <div id="pest-preview" class="hidden">
                        <img id="pest-image" class="image-preview" />
                    </div>
                    <div id="pest-result" class="hidden" style="margin-top: 20px;"></div>
                </div>
            </div>

            <!-- Map Page -->
            <div id="page-map" class="page hidden">
                <div class="page-header">
                    <h1 class="page-title" id="map-title">Local Risk Map</h1>
                    <p class="page-subtitle" id="map-subtitle">Community risk awareness around your area</p>
                </div>

                <div class="card">
                    <div id="risk-map"></div>
                </div>
            </div>

            <!-- Voice Page -->
            <div id="page-voice" class="page hidden">
                <div class="page-header">
                    <h1 class="page-title" id="voice-title">Voice Assistant</h1>
                    <p class="page-subtitle" id="voice-subtitle">Ask questions in Bangla</p>
                </div>

                <div class="card voice-container">
                    <button class="voice-button" id="voice-btn" onclick="toggleVoice()">
                        üé§
                    </button>
                    <p style="margin-top: 20px; color: var(--color-text-secondary);" id="voice-status">Click microphone to speak</p>
                    <div class="chat-messages" id="chat-messages"></div>
                </div>
            </div>

            <!-- Profile Page -->
            <div id="page-profile" class="page hidden">
                <div class="page-header">
                    <h1 class="page-title" id="profile-title">Your Profile</h1>
                    <p class="page-subtitle" id="profile-subtitle">Manage your information and achievements</p>
                </div>

                <div class="card" style="margin-bottom: 20px;">
                    <h2 style="margin-bottom: 20px;" id="profile-info-title">Profile Information</h2>
                    <div style="display: grid; gap: 12px;">
                        <div><strong id="profile-name-label">Name:</strong> <span id="profile-name"></span></div>
                        <div><strong id="profile-email-label">Email:</strong> <span id="profile-email"></span></div>
                        <div><strong id="profile-phone-label">Phone:</strong> <span id="profile-phone"></span></div>
                        <div><strong id="profile-lang-label">Language:</strong> <span id="profile-lang"></span></div>
                    </div>
                </div>

                <div class="card" style="margin-bottom: 20px;">
                    <h2 style="margin-bottom: 20px;" id="achievements-title">Achievements</h2>
                    <div class="badges-grid" id="badges-grid"></div>
                </div>

                <div class="card">
                    <h2 style="margin-bottom: 20px;" id="export-title">Export Data</h2>
                    <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                        <button class="btn btn-secondary" onclick="exportData('csv')" id="export-csv">üìä Export as CSV</button>
                        <button class="btn btn-secondary" onclick="exportData('json')" id="export-json">üìÑ Export as JSON</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Auth Modal -->
    <div id="auth-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header" id="auth-title">Register</div>
            
            <form id="register-form">
                <div class="form-group">
                    <label class="form-label" id="auth-name">Full Name</label>
                    <input type="text" class="form-control" id="reg-name" required>
                </div>
                <div class="form-group">
                    <label class="form-label" id="auth-email">Email</label>
                    <input type="email" class="form-control" id="reg-email" required>
                </div>
                <div class="form-group">
                    <label class="form-label" id="auth-phone">Phone Number</label>
                    <input type="tel" class="form-control" id="reg-phone" required>
                </div>
                <div class="form-group">
                    <label class="form-label" id="auth-password">Password</label>
                    <input type="password" class="form-control" id="reg-password" required>
                </div>
                <div class="form-group">
                    <label class="form-label" id="auth-lang">Preferred Language</label>
                    <select class="form-control" id="reg-lang">
                        <option value="en">English</option>
                        <option value="bn">‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;" id="btn-register">Register</button>
                <p style="text-align: center; margin-top: 16px;">
                    <span id="auth-have-account">Already have an account?</span>
                    <a href="#" onclick="showAuthModal('login'); return false;" style="color: var(--color-primary);" id="auth-login-link">Login</a>
                </p>
            </form>

            <form id="login-form" class="hidden">
                <div class="form-group">
                    <label class="form-label" id="login-email">Email</label>
                    <input type="email" class="form-control" id="login-email-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label" id="login-password">Password</label>
                    <input type="password" class="form-control" id="login-password-input" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;" id="btn-login">Login</button>
                <p style="text-align: center; margin-top: 16px;">
                    <span id="login-no-account">Don't have an account?</span>
                    <a href="#" onclick="showAuthModal('register'); return false;" style="color: var(--color-primary);" id="login-register-link">Register</a>
                </p>
            </form>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Firebase config and initialization
        const firebaseConfig = {
            apiKey: "AIzaSyCwk24-hDfTg3i0YA84phcGN164JxtYUyc",
            authDomain: "save-farmer-234ba.firebaseapp.com",
            projectId: "save-farmer-234ba",
            storageBucket: "save-farmer-234ba.firebasestorage.app",
            messagingSenderId: "330003063586",
            appId: "1:330003063586:web:53d028dcccbd9b6f973b7b"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        window.firebaseAuth = auth;

        // Check auth state
        auth.onAuthStateChanged((user) => {
            if (user) {
                const userData = window.appData?.user || {};
                if (userData.email === user.email) {
                    window.currentUser = userData;
                    document.getElementById('landing-page').classList.add('hidden');
                    document.getElementById('app-container').classList.remove('hidden');
                    initializeApp();
                }
            }
        });
    </script>
    <script>
        // Global state - In-memory storage (no localStorage)
        let currentUser = null;
        let currentLang = 'en';
        let currentBatches = [];
        let currentPage = 'dashboard';
        let map = null;
        let recognition = null;
        let synthesis = window.speechSynthesis;
        let isListening = false;
        let earnedBadges = [];
        let interventionsCount = 0;
        let appData = {}; // In-memory data store

        // API Keys
        const API_KEYS = {
            gemini: 'AIzaSyAelRlhaYJ9dnBYY68HnNL14c9F6JEasNQ',
            huggingface: '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',
            openweather: '5eb5c0863ca2eb45a1569195676200cc'
        };

        // Translations
        const translations = {
            en: {
                'hero-title': 'Save Bangladesh\'s Food. Save Our Future.',
                'hero-subtitle': 'Technology-powered solution to reduce food loss and empower farmers',
                'cta-text': 'Start Protecting Your Harvest',
                'stat1': 'Metric Tonnes of Food Lost Annually',
                'stat2': 'Economic Cost Every Year',
                'stat3': 'Staple Foods Lost in Supply Chain',
                'workflow1': 'Collect Data',
                'workflow2': 'Smart Warning',
                'workflow3': 'Take Action',
                'workflow4': 'Save Food',
                'dashboard-title': 'Dashboard',
                'dashboard-subtitle': 'Overview of your crops and alerts',
                'add-batch-title': 'Register New Crop Batch',
                'add-batch-subtitle': 'Add your harvested crops for monitoring',
                'weather-title': 'Weather Forecast',
                'weather-subtitle': '5-day weather outlook for your location',
                'scanner-title': 'Crop Health Scanner',
                'scanner-subtitle': 'Upload a photo to check crop freshness',
                'pest-title': 'Pest Identification',
                'pest-subtitle': 'AI-powered pest detection and treatment recommendations',
                'map-title': 'Local Risk Map',
                'map-subtitle': 'Community risk awareness around your area',
                'voice-title': 'Voice Assistant',
                'voice-subtitle': 'Ask questions in Bangla',
                'profile-title': 'Your Profile',
                'profile-subtitle': 'Manage your information and achievements',
                'label-crop': 'Crop Type',
                'label-weight': 'Weight (kg)',
                'label-harvest': 'Harvest Date',
                'label-location': 'Storage Location',
                'label-storage': 'Storage Type',
                'btn-submit': 'Register Batch',
                'stat-batches': 'Active Batches',
                'stat-risk': 'At Risk',
                'stat-interventions': 'Interventions',
                'stat-badges': 'Badges Earned',
                'batches-title': 'Your Crop Batches',
                'scanner-upload-text': 'Click or drag to upload crop photo',
                'scanner-formats': 'Supports: JPG, PNG',
                'pest-upload-text': 'Upload pest or damage photo',
                'pest-formats': 'Supports: JPG, PNG',
                'voice-status': 'Click microphone to speak',
                'profile-info-title': 'Profile Information',
                'profile-name-label': 'Name:',
                'profile-email-label': 'Email:',
                'profile-phone-label': 'Phone:',
                'profile-lang-label': 'Language:',
                'achievements-title': 'Achievements',
                'export-title': 'Export Data',
                'export-csv': 'üìä Export as CSV',
                'export-json': 'üìÑ Export as JSON',
                'auth-title': 'Register',
                'auth-name': 'Full Name',
                'auth-email': 'Email',
                'auth-phone': 'Phone Number',
                'auth-password': 'Password',
                'auth-lang': 'Preferred Language',
                'btn-register': 'Register',
                'auth-have-account': 'Already have an account?',
                'auth-login-link': 'Login',
                'login-email': 'Email',
                'login-password': 'Password',
                'btn-login': 'Login',
                'login-no-account': 'Don\'t have an account?',
                'login-register-link': 'Register',
                'nav-dashboard': 'Dashboard',
                'nav-add-batch': 'Add Crop Batch',
                'nav-weather': 'Weather',
                'nav-scanner': 'Crop Scanner',
                'nav-pest': 'Pest ID',
                'nav-map': 'Risk Map',
                'nav-voice': 'Voice Assistant',
                'nav-profile': 'Profile',
                'nav-logout': 'Logout',
                'loc-Dhaka': 'Dhaka',
                'loc-Narayanganj': 'Narayanganj',
                'loc-Gazipur': 'Gazipur',
                'loc-Sylhet': 'Sylhet',
                'loc-Chittagong': 'Chittagong',
                'storage-jute': 'Jute Bag Stack',
                'storage-silo': 'Silo',
                'storage-open': 'Open Area',
                'weather-humidity': 'Humidity',
                'weather-rain': 'Rain',
                'alert-highrain': 'Heavy rain expected in next 3 days ‚Äî consider harvesting or covering crops.',
                'alert-hightemp': 'High temperatures expected ‚Äî consider irrigation in the afternoon.',
                'alert-goodweather': 'Weather is favorable. Good time for storage and handling.'
            },
            bn: {
                'hero-title': '‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶¶‡ßá‡¶∂‡ßá‡¶∞ ‡¶ñ‡¶æ‡¶¶‡ßç‡¶Ø ‡¶¨‡¶æ‡¶Å‡¶ö‡¶æ‡¶®‡•§ ‡¶Ü‡¶Æ‡¶æ‡¶¶‡ßá‡¶∞ ‡¶≠‡¶¨‡¶ø‡¶∑‡ßç‡¶Ø‡ßé ‡¶¨‡¶æ‡¶Å‡¶ö‡¶æ‡¶®‡•§',
                'hero-subtitle': '‡¶ñ‡¶æ‡¶¶‡ßç‡¶Ø‡ßá‡¶∞ ‡¶ï‡ßç‡¶∑‡¶§‡¶ø ‡¶ï‡¶Æ‡¶æ‡¶§‡ßá ‡¶è‡¶¨‡¶Ç ‡¶ï‡ßÉ‡¶∑‡¶ï‡¶¶‡ßá‡¶∞ ‡¶ï‡ßç‡¶∑‡¶Æ‡¶§‡¶æ‡¶Ø‡¶º‡¶®‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶™‡ßç‡¶∞‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§‡¶ø-‡¶ö‡¶æ‡¶≤‡¶ø‡¶§ ‡¶∏‡¶Æ‡¶æ‡¶ß‡¶æ‡¶®',
                'cta-text': '‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶´‡¶∏‡¶≤ ‡¶∏‡ßÅ‡¶∞‡¶ï‡ßç‡¶∑‡¶æ ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶®',
                'stat1': '‡¶Æ‡ßá‡¶ü‡ßç‡¶∞‡¶ø‡¶ï ‡¶ü‡¶® ‡¶ñ‡¶æ‡¶¶‡ßç‡¶Ø ‡¶™‡ßç‡¶∞‡¶§‡¶ø ‡¶¨‡¶õ‡¶∞ ‡¶π‡¶æ‡¶∞‡¶æ‡¶Ø‡¶º',
                'stat2': '‡¶™‡ßç‡¶∞‡¶§‡¶ø ‡¶¨‡¶õ‡¶∞ ‡¶Ö‡¶∞‡ßç‡¶•‡¶®‡ßà‡¶§‡¶ø‡¶ï ‡¶ñ‡¶∞‡¶ö',
                'stat3': '‡¶∏‡¶∞‡¶¨‡¶∞‡¶æ‡¶π ‡¶∂‡ßÉ‡¶ô‡ßç‡¶ñ‡¶≤‡ßá ‡¶™‡ßç‡¶∞‡¶ß‡¶æ‡¶® ‡¶ñ‡¶æ‡¶¶‡ßç‡¶Ø ‡¶π‡¶æ‡¶∞‡¶æ‡¶Ø‡¶º',
                'workflow1': '‡¶°‡ßá‡¶ü‡¶æ ‡¶∏‡¶Ç‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßÅ‡¶®',
                'workflow2': '‡¶∏‡ßç‡¶Æ‡¶æ‡¶∞‡ßç‡¶ü ‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶§‡¶æ',
                'workflow3': '‡¶™‡¶¶‡¶ï‡ßç‡¶∑‡ßá‡¶™ ‡¶®‡¶ø‡¶®',
                'workflow4': '‡¶ñ‡¶æ‡¶¶‡ßç‡¶Ø ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®',
                'dashboard-title': '‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°',
                'dashboard-subtitle': '‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶´‡¶∏‡¶≤ ‡¶è‡¶¨‡¶Ç ‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶§‡¶æ‡¶∞ ‡¶∏‡¶Ç‡¶ï‡ßç‡¶∑‡¶ø‡¶™‡ßç‡¶§ ‡¶¨‡¶ø‡¶¨‡¶∞‡¶£',
                'add-batch-title': '‡¶®‡¶§‡ßÅ‡¶® ‡¶´‡¶∏‡¶≤‡ßá‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ö ‡¶®‡¶ø‡¶¨‡¶®‡ßç‡¶ß‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®',
                'add-batch-subtitle': '‡¶™‡¶∞‡ßç‡¶Ø‡¶¨‡ßá‡¶ï‡ßç‡¶∑‡¶£‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∏‡¶Ç‡¶ó‡ßÉ‡¶π‡ßÄ‡¶§ ‡¶´‡¶∏‡¶≤ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®',
                'weather-title': '‡¶Ü‡¶¨‡¶π‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡¶æ‡¶≠‡¶æ‡¶∏',
                'weather-subtitle': '‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶®‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡ß´ ‡¶¶‡¶ø‡¶®‡ßá‡¶∞ ‡¶Ü‡¶¨‡¶π‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶¶‡ßÉ‡¶∑‡ßç‡¶ü‡¶ø‡¶≠‡¶ô‡ßç‡¶ó‡¶ø',
                'scanner-title': '‡¶´‡¶∏‡¶≤‡ßá‡¶∞ ‡¶∏‡ßç‡¶¨‡¶æ‡¶∏‡ßç‡¶•‡ßç‡¶Ø ‡¶∏‡ßç‡¶ï‡ßç‡¶Ø‡¶æ‡¶®‡¶æ‡¶∞',
                'scanner-subtitle': '‡¶´‡¶∏‡¶≤‡ßá‡¶∞ ‡¶§‡¶æ‡¶ú‡¶æ ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡¶§‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶õ‡¶¨‡¶ø ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®',
                'pest-title': '‡¶ï‡ßÄ‡¶ü‡¶™‡¶§‡¶ô‡ßç‡¶ó ‡¶∏‡¶®‡¶æ‡¶ï‡ßç‡¶§‡¶ï‡¶∞‡¶£',
                'pest-subtitle': '‡¶è‡¶Ü‡¶á-‡¶ö‡¶æ‡¶≤‡¶ø‡¶§ ‡¶ï‡ßÄ‡¶ü‡¶™‡¶§‡¶ô‡ßç‡¶ó ‡¶∏‡¶®‡¶æ‡¶ï‡ßç‡¶§‡¶ï‡¶∞‡¶£ ‡¶è‡¶¨‡¶Ç ‡¶ö‡¶ø‡¶ï‡¶ø‡ßé‡¶∏‡¶æ‡¶∞ ‡¶∏‡ßÅ‡¶™‡¶æ‡¶∞‡¶ø‡¶∂',
                'map-title': '‡¶∏‡ßç‡¶•‡¶æ‡¶®‡ßÄ‡¶Ø‡¶º ‡¶ù‡ßÅ‡¶Å‡¶ï‡¶ø ‡¶Æ‡¶æ‡¶®‡¶ö‡¶ø‡¶§‡ßç‡¶∞',
                'map-subtitle': '‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶è‡¶≤‡¶æ‡¶ï‡¶æ‡¶∞ ‡¶ö‡¶æ‡¶∞‡¶™‡¶æ‡¶∂‡ßá ‡¶∏‡¶Æ‡ßç‡¶™‡ßç‡¶∞‡¶¶‡¶æ‡¶Ø‡¶º ‡¶ù‡ßÅ‡¶Å‡¶ï‡¶ø ‡¶∏‡¶ö‡ßá‡¶§‡¶®‡¶§‡¶æ',
                'voice-title': '‡¶≠‡¶Ø‡¶º‡ßá‡¶∏ ‡¶∏‡¶π‡¶æ‡¶Ø‡¶º‡¶ï',
                'voice-subtitle': '‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶Ø‡¶º ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶ú‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶∏‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®',
                'profile-title': '‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤',
                'profile-subtitle': '‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø ‡¶è‡¶¨‡¶Ç ‡¶Ö‡¶∞‡ßç‡¶ú‡¶® ‡¶™‡¶∞‡¶ø‡¶ö‡¶æ‡¶≤‡¶®‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®',
                'label-crop': '‡¶´‡¶∏‡¶≤‡ßá‡¶∞ ‡¶ß‡¶∞‡¶®',
                'label-weight': '‡¶ì‡¶ú‡¶® (‡¶ï‡ßá‡¶ú‡¶ø)',
                'label-harvest': '‡¶´‡¶∏‡¶≤‡ßá‡¶∞ ‡¶ï‡¶æ‡¶ü‡¶æ‡¶á ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ',
                'label-location': '‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶∏‡ßç‡¶•‡¶æ‡¶®',
                'label-storage': '‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£‡ßá‡¶∞ ‡¶ß‡¶∞‡¶®',
                'btn-submit': '‡¶¨‡ßç‡¶Ø‡¶æ‡¶ö ‡¶®‡¶ø‡¶¨‡¶®‡ßç‡¶ß‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®',
                'stat-batches': '‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ö',
                'stat-risk': '‡¶ù‡ßÅ‡¶Å‡¶ï‡¶ø‡¶§‡ßá ‡¶Ü‡¶õ‡ßá',
                'stat-interventions': '‡¶π‡¶∏‡ßç‡¶§‡¶ï‡ßç‡¶∑‡ßá‡¶™',
                'stat-badges': '‡¶Ö‡¶∞‡ßç‡¶ú‡¶ø‡¶§ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ú',
                'batches-title': '‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶´‡¶∏‡¶≤ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ö',
                'scanner-upload-text': '‡¶´‡¶∏‡¶≤‡ßá‡¶∞ ‡¶õ‡¶¨‡¶ø ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶¨‡¶æ ‡¶ü‡ßá‡¶®‡ßá ‡¶Ü‡¶®‡ßÅ‡¶®',
                'scanner-formats': '‡¶∏‡¶Æ‡¶∞‡ßç‡¶•‡¶®: JPG, PNG',
                'pest-upload-text': '‡¶ï‡ßÄ‡¶ü‡¶™‡¶§‡¶ô‡ßç‡¶ó ‡¶¨‡¶æ ‡¶ï‡ßç‡¶∑‡¶§‡¶ø‡¶∞ ‡¶õ‡¶¨‡¶ø ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®',
                'pest-formats': '‡¶∏‡¶Æ‡¶∞‡ßç‡¶•‡¶®: JPG, PNG',
                'voice-status': '‡¶ï‡¶•‡¶æ ‡¶¨‡¶≤‡¶§‡ßá ‡¶Æ‡¶æ‡¶á‡¶ï‡ßç‡¶∞‡ßã‡¶´‡ßã‡¶® ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®',
                'profile-info-title': '‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶§‡¶•‡ßç‡¶Ø',
                'profile-name-label': '‡¶®‡¶æ‡¶Æ:',
                'profile-email-label': '‡¶á‡¶Æ‡ßá‡¶á‡¶≤',
                'profile-phone-label': '‡¶´‡ßã‡¶®:',
                'profile-lang-label': '‡¶≠‡¶æ‡¶∑‡¶æ:',
                'achievements-title': '‡¶Ö‡¶∞‡ßç‡¶ú‡¶®',
                'export-title': '‡¶°‡ßá‡¶ü‡¶æ ‡¶è‡¶ï‡ßç‡¶∏‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®',
                'export-csv': 'üìä CSV ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨‡ßá ‡¶è‡¶ï‡ßç‡¶∏‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®',
                'export-json': 'üìÑ JSON ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨‡ßá ‡¶è‡¶ï‡ßç‡¶∏‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®',
                'auth-title': '‡¶®‡¶ø‡¶¨‡¶®‡ßç‡¶ß‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®',
                'auth-name': '‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶®‡¶æ‡¶Æ',
                'auth-email': '‡¶á‡¶Æ‡ßá‡¶á‡¶≤',
                'auth-phone': '‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞',
                'auth-password': '‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶°',
                'auth-lang': '‡¶™‡¶õ‡¶®‡ßç‡¶¶‡ßá‡¶∞ ‡¶≠‡¶æ‡¶∑‡¶æ',
                'btn-register': '‡¶®‡¶ø‡¶¨‡¶®‡ßç‡¶ß‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®',
                'auth-have-account': '‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶Ü‡¶õ‡ßá?',
                'auth-login-link': '‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®',
                'login-email': '‡¶á‡¶Æ‡ßá‡¶á‡¶≤',
                'login-password': '‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶°',
                'btn-login': '‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®',
                'login-no-account': '‡¶ï‡ßã‡¶®‡ßã ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶®‡ßá‡¶á?',
                'login-register-link': '‡¶®‡¶ø‡¶¨‡¶®‡ßç‡¶ß‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®',
                'nav-dashboard': '‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°',
                'nav-add-batch': '‡¶´‡¶∏‡¶≤ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®',
                'nav-weather': '‡¶Ü‡¶¨‡¶π‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ',
                'nav-scanner': '‡¶´‡¶∏‡¶≤ ‡¶∏‡ßç‡¶ï‡ßç‡¶Ø‡¶æ‡¶®‡¶æ‡¶∞',
                'nav-pest': '‡¶ï‡ßÄ‡¶ü‡¶™‡¶§‡¶ô‡ßç‡¶ó ‡¶∂‡¶®‡¶æ‡¶ï‡ßç‡¶§‡¶ï‡¶∞‡¶£',
                'nav-map': '‡¶ù‡ßÅ‡¶Å‡¶ï‡¶ø ‡¶Æ‡¶æ‡¶®‡¶ö‡¶ø‡¶§‡ßç‡¶∞',
                'nav-voice': '‡¶≠‡¶Ø‡¶º‡ßá‡¶∏ ‡¶∏‡¶π‡¶æ‡¶Ø‡¶º‡¶ï',
                'nav-profile': '‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤',
                'nav-logout': '‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®',
                'loc-Dhaka': '‡¶¢‡¶æ‡¶ï‡¶æ',
                'loc-Narayanganj': '‡¶®‡¶æ‡¶∞‡¶æ‡ßü‡¶£‡¶ó‡¶û‡ßç‡¶ú',
                'loc-Gazipur': '‡¶ó‡¶æ‡¶ú‡ßÄ‡¶™‡ßÅ‡¶∞',
                'loc-Sylhet': '‡¶∏‡¶ø‡¶≤‡ßá‡¶ü',
                'loc-Chittagong': '‡¶ö‡¶ü‡ßç‡¶ü‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ',
                'storage-jute': '‡¶™‡¶æ‡¶ü‡ßá‡¶∞ ‡¶¨‡ßã‡¶∞‡¶æ‡¶Ø‡¶º ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ï',
                'storage-silo': '‡¶∏‡¶ø‡¶≤‡ßã',
                'storage-open': '‡¶ñ‡ßã‡¶≤‡¶æ ‡¶∏‡ßç‡¶•‡¶æ‡¶®‡ßá',
                'weather-humidity': '‡¶Ü‡¶∞‡ßç‡¶¶‡ßç‡¶∞‡¶§‡¶æ',
                'weather-rain': '‡¶¨‡ßÉ‡¶∑‡ßç‡¶ü‡¶ø',
                'alert-highrain': '‡¶Ü‡¶ó‡¶æ‡¶Æ‡ßÄ ‡ß© ‡¶¶‡¶ø‡¶® ‡¶¨‡ßÉ‡¶∑‡ßç‡¶ü‡¶ø ‡ßÆ‡ß´% ‚Üí ‡¶Ü‡¶ú‡¶á ‡¶ß‡¶æ‡¶® ‡¶ï‡¶æ‡¶ü‡ßÅ‡¶® ‡¶Ö‡¶•‡¶¨‡¶æ ‡¶¢‡ßá‡¶ï‡ßá ‡¶∞‡¶æ‡¶ñ‡ßÅ‡¶®‡•§',
                'alert-hightemp': '‡¶§‡¶æ‡¶™‡¶Æ‡¶æ‡¶§‡ßç‡¶∞‡¶æ ‡ß©‡ß¨¬∞C ‡¶â‡¶†‡¶¨‡ßá ‚Üí ‡¶¨‡¶ø‡¶ï‡ßá‡¶≤‡ßá‡¶∞ ‡¶¶‡¶ø‡¶ï‡ßá ‡¶∏‡ßá‡¶ö ‡¶¶‡¶ø‡¶®‡•§',
                'alert-goodweather': '‡¶Ü‡¶¨‡¶π‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ö‡¶®‡ßÅ‡¶ï‡ßÇ‡¶≤‡•§ ‡¶´‡¶∏‡¶≤ ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶≠‡¶æ‡¶≤‡ßã ‡¶∏‡¶Æ‡¶Ø‡¶º‡•§'
            }
        };

        // Toggle language
        function toggleLanguage() {
            currentLang = currentLang === 'en' ? 'bn' : 'en';
            document.getElementById('lang-text').textContent = currentLang === 'en' ? '‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ' : 'English';
            const langToggleApp = document.getElementById('lang-toggle-app');
            if (langToggleApp) {
                langToggleApp.textContent = currentLang === 'en' ? '‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ' : 'English';
            }
            updateLanguage();
        }

        function updateLanguage() {
            const trans = translations[currentLang] || {};

            // Update elements by id
            Object.keys(trans).forEach(key => {
                const el = document.getElementById(key);
                if (el) el.textContent = trans[key];
            });

            // Update elements with data-i18n attribute (e.g., option texts)
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (key && trans[key]) {
                    el.textContent = trans[key];
                }
            });

            // Update certain dynamic texts not covered by id/data attributes
            const langToggleApp = document.getElementById('lang-toggle-app');
            if (langToggleApp) langToggleApp.textContent = currentLang === 'en' ? '‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ' : 'English';

            // Update weather date locale for any visible weather cards if present
            if (document.getElementById('weather-grid')) {
                // if weather cards exist, re-load to update locale/labels
                if (currentPage === 'weather') loadWeather();
            }
        }

        // Auth Modal
        function showAuthModal(type) {
            const modal = document.getElementById('auth-modal');
            const registerForm = document.getElementById('register-form');
            const loginForm = document.getElementById('login-form');
            const title = document.getElementById('auth-title');

            if (type === 'register') {
                registerForm.classList.remove('hidden');
                loginForm.classList.add('hidden');
                title.textContent = 'Register';
            } else {
                registerForm.classList.add('hidden');
                loginForm.classList.remove('hidden');
                title.textContent = 'Login';
            }

            modal.classList.remove('hidden');
        }

        // Register form
        document.getElementById('register-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('reg-name').value;
            const email = document.getElementById('reg-email').value;
            const phone = document.getElementById('reg-phone').value;
            const password = document.getElementById('reg-password').value;
            const lang = document.getElementById('reg-lang').value;

            try {
                const userCredential = await window.firebaseAuth.createUserWithEmailAndPassword(
                    email,
                    password
                );

                const userData = {
                    name,
                    email,
                    phone,
                    lang,
                    createdAt: new Date().toISOString()
                };

                // Store in memory
                appData.user = userData;
                currentUser = userData;
                currentLang = lang;

                // Persist to localStorage so session survives reloads
                try {
                    localStorage.setItem('amarkrishi_appData', JSON.stringify(appData));
                } catch (e) {
                    console.warn('localStorage write failed', e);
                }

                document.getElementById('auth-modal').classList.add('hidden');
                document.getElementById('landing-page').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');

                initializeApp();
                showToast('Registration successful!');
            } catch (error) {
                alert('Registration failed: ' + error.message);
            }
        });

        // Login form
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email-input').value;
            const password = document.getElementById('login-password-input').value;

            try {
                await window.firebaseAuth.signInWithEmailAndPassword(
                    email,
                    password
                );

                // Build userData from Firebase user and any stored in-memory fields
                const fbUser = window.firebaseAuth.currentUser;
                const stored = appData.user || {};
                const userData = (stored.email === fbUser?.email) ? stored : {
                    name: fbUser?.displayName || (fbUser?.email ? fbUser.email.split('@')[0] : 'Farmer'),
                    email: fbUser?.email || email,
                    phone: stored.phone || '',
                    lang: stored.lang || 'en',
                    createdAt: stored.createdAt || new Date().toISOString()
                };

                // Persist and set current user
                appData.user = userData;
                currentUser = userData;
                currentLang = userData.lang || 'en';
                try {
                    localStorage.setItem('amarkrishi_appData', JSON.stringify(appData));
                } catch (e) {
                    console.warn('localStorage write failed', e);
                }

                document.getElementById('auth-modal').classList.add('hidden');
                document.getElementById('landing-page').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');

                initializeApp();
                showToast('Login successful!');
            } catch (error) {
                alert('Login failed: ' + error.message);
            }
        });

        // Initialize app
        function initializeApp() {
            // Ensure language and translations are applied
            if (currentLang) {
                document.getElementById('lang-text').textContent = currentLang === 'en' ? '‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ' : 'English';
                const langToggleApp = document.getElementById('lang-toggle-app');
                if (langToggleApp) langToggleApp.textContent = currentLang === 'en' ? '‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ' : 'English';
            }
            updateLanguage();

            document.getElementById('user-name').textContent = currentUser?.name || '';
            loadBatches();
            updateDashboard();
            loadWeather();
            initializeMap();
            updateBadges();
            updateProfile();
        }

        // Show page
        function showPage(page) {
            document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
            document.getElementById(`page-${page}`).classList.remove('hidden');
            
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.currentTarget.classList.add('active');
            
            currentPage = page;

            if (page === 'map' && !map) {
                setTimeout(() => initializeMap(), 100);
            }
        }

        // Load batches
        function loadBatches() {
            currentBatches = appData.batches || [];
            updateBatchList();
        }

        // Submit batch
        function submitBatch(e) {
            e.preventDefault();
            
            const batch = {
                id: Date.now(),
                cropType: document.getElementById('crop-type').value,
                weight: document.getElementById('crop-weight').value,
                harvestDate: document.getElementById('harvest-date').value,
                location: document.getElementById('storage-location').value,
                storageType: document.getElementById('storage-type').value,
                status: 'active',
                risk: calculateRisk(),
                createdAt: new Date().toISOString()
            };

            currentBatches.push(batch);
            appData.batches = currentBatches;
            
            checkAndAwardBadge('first_harvest');
            incrementInterventions();
            
            showToast('Batch registered successfully!');
            document.getElementById('batch-form').reset();
            showPage('dashboard');
            updateDashboard();
            generateSmartAlert(batch);
        }

        // Calculate risk
        function calculateRisk() {
            const risks = ['Low', 'Medium', 'High'];
            return risks[Math.floor(Math.random() * risks.length)];
        }

        // Update batch list
        function updateBatchList() {
            const container = document.getElementById('batch-list');
            
            if (currentBatches.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--color-text-secondary); padding: 40px;">No batches registered yet</p>';
                return;
            }

            container.innerHTML = currentBatches.map(batch => `
                <div class="batch-item">
                    <div class="batch-info">
                        <div class="batch-title">üåæ ${batch.cropType} - ${batch.weight}kg</div>
                        <div class="batch-details">
                            üìç ${batch.location} | üì¶ ${batch.storageType} | üìÖ ${new Date(batch.harvestDate).toLocaleDateString()}
                        </div>
                    </div>
                    <span class="risk-badge risk-${batch.risk.toLowerCase()}">${batch.risk}</span>
                </div>
            `).join('');
        }

        // Update dashboard
        function updateDashboard() {
            const activeBatches = currentBatches.filter(b => b.status === 'active').length;
            const atRisk = currentBatches.filter(b => b.risk === 'High' || b.risk === 'Medium').length;
            const interventions = interventionsCount;
            const badges = earnedBadges.length;

            document.getElementById('total-batches').textContent = activeBatches;
            document.getElementById('at-risk-batches').textContent = atRisk;
            document.getElementById('interventions').textContent = interventions;
            document.getElementById('badges-earned').textContent = badges;

            updateBatchList();
            displayAlerts();
        }

        // Display alerts
        function displayAlerts() {
            const container = document.getElementById('alerts-container');
            const highRiskBatches = currentBatches.filter(b => b.risk === 'High');
            
            if (highRiskBatches.length > 0) {
                const alerts = highRiskBatches.map(batch => `
                    <div class="alert alert-danger">
                        <span style="font-size: 24px;">‚ö†Ô∏è</span>
                        <div>
                            <strong>‡¶â‡¶ö‡ßç‡¶ö ‡¶ù‡ßÅ‡¶Å‡¶ï‡¶ø ‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶§‡¶æ!</strong>
                            <p style="margin: 4px 0 0 0;">
                                ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ${batch.cropType} (${batch.location}) ‡¶â‡¶ö‡ßç‡¶ö ‡¶ù‡ßÅ‡¶Å‡¶ï‡¶ø‡¶§‡ßá ‡¶Ü‡¶õ‡ßá‡•§ 
                                ‡¶Ü‡¶ó‡¶æ‡¶Æ‡ßÄ ‡ß≠‡ß® ‡¶ò‡¶£‡ßç‡¶ü‡¶æ‡¶∞ ‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶™‡¶¶‡¶ï‡ßç‡¶∑‡ßá‡¶™ ‡¶®‡¶ø‡¶®‡•§
                            </p>
                        </div>
                    </div>
                `).join('');
                container.innerHTML = alerts;

                // Console SMS simulation
                console.log('üö® SMS ALERT: High risk detected for batch. Take action within 72 hours.');
            } else {
                container.innerHTML = '';
            }
        }

        // Generate smart alert
        function generateSmartAlert(batch) {
            const alerts = [
                `‡¶Ü‡¶ó‡¶æ‡¶Æ‡ßÄ‡¶ï‡¶æ‡¶≤ ‡¶¨‡ßÉ‡¶∑‡ßç‡¶ü‡¶ø ‡¶π‡¶¨‡ßá ‡¶è‡¶¨‡¶Ç ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ${batch.cropType} ‡¶ó‡ßÅ‡¶¶‡¶æ‡¶Æ‡ßá ‡¶Ü‡¶∞‡ßç‡¶¶‡ßç‡¶∞‡¶§‡¶æ ‡¶¨‡ßá‡¶∂‡¶ø‡•§ ‡¶è‡¶ñ‡¶®‡¶á ‡¶´‡ßç‡¶Ø‡¶æ‡¶® ‡¶ö‡¶æ‡¶≤‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§`,
                `‡¶§‡¶æ‡¶™‡¶Æ‡¶æ‡¶§‡ßç‡¶∞‡¶æ ‡ß©‡ß¨¬∞C ‡¶â‡¶†‡¶¨‡ßá ‚Üí ‡¶¨‡¶ø‡¶ï‡ßá‡¶≤‡ßá‡¶∞ ‡¶¶‡¶ø‡¶ï‡ßá ‡¶∏‡¶§‡¶∞‡ßç‡¶ï ‡¶•‡¶æ‡¶ï‡ßÅ‡¶® ‡¶è‡¶¨‡¶Ç ${batch.location} ‡¶è ‡¶¨‡¶æ‡¶Ø‡¶º‡ßÅ‡¶ö‡¶≤‡¶æ‡¶ö‡¶≤ ‡¶¨‡¶æ‡¶°‡¶º‡¶æ‡¶®‡•§`,
                `‡¶Ü‡¶ó‡¶æ‡¶Æ‡ßÄ ‡ß© ‡¶¶‡¶ø‡¶® ‡¶¨‡ßÉ‡¶∑‡ßç‡¶ü‡¶ø ‡ßÆ‡ß´% ‚Üí ‡¶Ü‡¶ú‡¶á ‡¶ß‡¶æ‡¶® ‡¶ï‡¶æ‡¶ü‡ßÅ‡¶® ‡¶Ö‡¶•‡¶¨‡¶æ ‡¶¢‡ßá‡¶ï‡ßá ‡¶∞‡¶æ‡¶ñ‡ßÅ‡¶®‡•§`,
                `${batch.storageType} ‡¶è ‡¶â‡¶ö‡ßç‡¶ö ‡¶Ü‡¶∞‡ßç‡¶¶‡ßç‡¶∞‡¶§‡¶æ ‡¶∏‡¶®‡¶æ‡¶ï‡ßç‡¶§‡•§ ‡¶Ö‡¶¨‡¶ø‡¶≤‡¶Æ‡ßç‡¶¨‡ßá ‡¶∂‡ßÅ‡¶ï‡¶æ‡¶®‡ßã‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡ßç‡¶•‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§`
            ];

            const alert = alerts[Math.floor(Math.random() * alerts.length)];
            
            setTimeout(() => {
                showToast(alert, 'warning');
                console.log('üì± SMS NOTIFICATION:', alert);
            }, 2000);
        }

        // Load weather
        async function loadWeather() {
            const container = document.getElementById('weather-grid');
            const location = currentBatches.length > 0 ? currentBatches[0].location : 'Dhaka';
            
            // Mock coordinates for Bangladesh districts
            const coords = {
                'Dhaka': { lat: 23.8103, lon: 90.4125 },
                'Sylhet': { lat: 24.8949, lon: 91.8687 },
                'Chittagong': { lat: 22.3569, lon: 91.7832 },
                'Narayanganj': { lat: 23.6238, lon: 90.5000 },
                'Gazipur': { lat: 24.0022, lon: 90.4264 }
            };

            const coord = coords[location] || coords['Dhaka'];

            try {
                const response = await fetch(
                    `https://api.openweathermap.org/data/2.5/forecast?lat=${coord.lat}&lon=${coord.lon}&appid=${API_KEYS.openweather}&units=metric&lang=${currentLang === 'bn' ? 'bn' : 'en'}`
                );
                const data = await response.json();

                // Get one forecast per day (every 8th item = 24 hours)
                const dailyForecasts = (data.list || []).filter((item, index) => index % 8 === 0).slice(0, 5);

                container.innerHTML = dailyForecasts.map(day => {
                    const date = new Date(day.dt * 1000);
                    const temp = Math.round(day.main.temp);
                    const humidity = day.main.humidity;
                    const rain = day.pop * 100;

                    return `
                        <div class="weather-card">
                            <div class="weather-date">${date.toLocaleDateString(currentLang === 'bn' ? 'bn-BD' : 'en-US', { weekday: 'short', month: 'short', day: 'numeric' })}</div>
                            <div class="weather-icon">${getWeatherIcon(day.weather[0].main)}</div>
                            <div class="weather-temp">${temp}¬∞C</div>
                            <div style="font-size: 14px; color: var(--color-text-secondary);">
                                üíß ${translations[currentLang]['weather-humidity']}: ${humidity}%<br>
                                üåßÔ∏è ${translations[currentLang]['weather-rain']}: ${Math.round(rain)}%
                            </div>
                        </div>
                    `;
                }).join('');

                // Generate weather advisory
                const highRain = dailyForecasts.some(d => d.pop > 0.7);
                const highTemp = dailyForecasts.some(d => d.main.temp > 35);
                
                const alertsContainer = document.getElementById('weather-alerts');
                if (highRain) {
                    alertsContainer.innerHTML = `
                        <div class="alert alert-warning">
                            <span style="font-size: 24px;">üåßÔ∏è</span>
                            <div>${translations[currentLang]['alert-highrain']}</div>
                        </div>
                    `;
                } else if (highTemp) {
                    alertsContainer.innerHTML = `
                        <div class="alert alert-warning">
                            <span style="font-size: 24px;">üå°Ô∏è</span>
                            <div>${translations[currentLang]['alert-hightemp']}</div>
                        </div>
                    `;
                } else {
                    alertsContainer.innerHTML = `
                        <div class="alert alert-success">
                            <span style="font-size: 24px;">‚úÖ</span>
                            <div>${translations[currentLang]['alert-goodweather']}</div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Weather fetch error:', error);
                container.innerHTML = `<p style="text-align: center; color: var(--color-text-secondary);">${currentLang === 'bn' ? '‡¶Ü‡¶¨‡¶π‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶ö‡ßç‡¶õ‡ßá ‡¶®‡¶æ' : 'Unable to load weather data'}</p>`;
            }
        }

        function getWeatherIcon(condition) {
            const icons = {
                'Clear': '‚òÄÔ∏è',
                'Clouds': '‚òÅÔ∏è',
                'Rain': 'üåßÔ∏è',
                'Drizzle': 'üå¶Ô∏è',
                'Thunderstorm': '‚õàÔ∏è',
                'Snow': '‚ùÑÔ∏è',
                'Mist': 'üå´Ô∏è',
                'Fog': 'üå´Ô∏è'
            };
            return icons[condition] || 'üå§Ô∏è';
        }

        // Handle scanner upload
        function handleScannerUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                document.getElementById('scanner-image').src = e.target.result;
                document.getElementById('scanner-preview').classList.remove('hidden');
                
                // Mock classification
                setTimeout(() => {
                    const isFresh = Math.random() > 0.5;
                    const confidence = Math.floor(Math.random() * 20) + 80;
                    
                    document.getElementById('scanner-result').innerHTML = `
                        <div class="card" style="background: ${isFresh ? 'var(--color-bg-1)' : 'rgba(192, 21, 47, 0.1)'}; border-left: 4px solid ${isFresh ? 'var(--color-success)' : 'var(--color-error)'}">
                            <h3 style="margin-bottom: 12px;">${isFresh ? '‚úÖ Fresh' : '‚ö†Ô∏è Rotten'}</h3>
                            <p style="font-size: 18px; margin-bottom: 8px;">Confidence: ${confidence}%</p>
                            <p style="color: var(--color-text-secondary);">
                                ${isFresh ? 'Your crop appears to be fresh and healthy. Continue proper storage practices.' : 'Warning: Signs of deterioration detected. Consider immediate intervention or processing.'}
                            </p>
                        </div>
                    `;
                    document.getElementById('scanner-result').classList.remove('hidden');
                }, 1500);
            };
            reader.readAsDataURL(file);
        }

        // Handle pest upload
        async function handlePestUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                document.getElementById('pest-image').src = e.target.result;
                document.getElementById('pest-preview').classList.remove('hidden');
                
                // Show loading
                document.getElementById('pest-result').innerHTML = '<div class="spinner"></div>';
                document.getElementById('pest-result').classList.remove('hidden');

                try {
                    // Convert image to base64 without data URL prefix
                    const base64Image = e.target.result.split(',')[1];

                    const response = await fetch(
                        `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEYS.gemini}`,
                        {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{
                                    parts: [
                                        { text: 'Analyze this image of a crop pest or damage. Identify the pest or disease, assess the risk level (High/Medium/Low), and provide treatment recommendations in Bangla suitable for Bangladesh farmers. Focus on local, accessible methods.' },
                                        {
                                            inline_data: {
                                                mime_type: file.type,
                                                data: base64Image
                                            }
                                        }
                                    ]
                                }]
                            })
                        }
                    );

                    const data = await response.json();
                    const result = data.candidates[0].content.parts[0].text;

                    document.getElementById('pest-result').innerHTML = `
                        <div class="card" style="background: var(--color-bg); border-left: 4px solid var(--color-warning);">
                            <h3 style="margin-bottom: 16px;">üîç ‡¶∏‡¶®‡¶æ‡¶ï‡ßç‡¶§‡¶ï‡¶∞‡¶£ ‡¶´‡¶≤‡¶æ‡¶´‡¶≤</h3>
                            <div style="white-space: pre-wrap; line-height: 1.8;">${result}</div>
                        </div>
                    `;
                    
                    checkAndAwardBadge('pest_finder');
                } catch (error) {
                    console.error('Pest identification error:', error);
                    
                    // Fallback mock response
                    document.getElementById('pest-result').innerHTML = `
                        <div class="card" style="background: var(--color-bg); border-left: 4px solid var(--color-warning);">
                            <h3 style="margin-bottom: 16px;">üîç ‡¶∏‡¶®‡¶æ‡¶ï‡ßç‡¶§‡¶ï‡¶∞‡¶£ ‡¶´‡¶≤‡¶æ‡¶´‡¶≤</h3>
                            <p><strong>‡¶ï‡ßÄ‡¶ü‡¶™‡¶§‡¶ô‡ßç‡¶ó:</strong> ‡¶ß‡¶æ‡¶®‡ßá‡¶∞ ‡¶Æ‡¶æ‡¶ú‡¶∞‡¶æ ‡¶™‡ßã‡¶ï‡¶æ (Rice Stem Borer)</p>
                            <p><strong>‡¶ù‡ßÅ‡¶Å‡¶ï‡¶ø ‡¶∏‡ßç‡¶§‡¶∞:</strong> <span style="color: var(--color-warning);">‡¶Æ‡¶æ‡¶ù‡¶æ‡¶∞‡¶ø</span></p>
                            <h4 style="margin-top: 16px;">‡¶ö‡¶ø‡¶ï‡¶ø‡ßé‡¶∏‡¶æ ‡¶™‡¶∞‡¶ø‡¶ï‡¶≤‡ßç‡¶™‡¶®‡¶æ:</h4>
                            <ul style="line-height: 1.8;">
                                <li>‡¶®‡¶ø‡¶Æ‡ßá‡¶∞ ‡¶§‡ßá‡¶≤ ‡¶∏‡ßç‡¶™‡ßç‡¶∞‡ßá ‡¶ï‡¶∞‡ßÅ‡¶® (‡ßß ‡¶≤‡¶ø‡¶ü‡¶æ‡¶∞ ‡¶™‡¶æ‡¶®‡¶ø‡¶§‡ßá ‡ß´ ‡¶Æ‡¶ø‡¶≤‡¶ø)</li>
                                <li>‡¶Ü‡¶ï‡ßç‡¶∞‡¶æ‡¶®‡ßç‡¶§ ‡¶ó‡¶æ‡¶õ ‡¶§‡ßÅ‡¶≤‡ßá ‡¶™‡ßÅ‡¶°‡¶º‡¶ø‡¶Ø‡¶º‡ßá ‡¶´‡ßá‡¶≤‡ßÅ‡¶®</li>
                                <li>‡¶ú‡ßà‡¶¨ ‡¶ï‡ßÄ‡¶ü‡¶®‡¶æ‡¶∂‡¶ï ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®</li>
                                <li>‡¶®‡¶ø‡¶Ø‡¶º‡¶Æ‡¶ø‡¶§ ‡¶Æ‡¶®‡¶ø‡¶ü‡¶∞‡¶ø‡¶Ç ‡¶ï‡¶∞‡ßÅ‡¶®</li>
                            </ul>
                        </div>
                    `;
                    
                    checkAndAwardBadge('pest_finder');
                }
            };
            reader.readAsDataURL(file);
        }

        // Initialize map
        function initializeMap() {
            if (map) return;

            const mapElement = document.getElementById('risk-map');
            if (!mapElement || mapElement.offsetParent === null) return;

            const location = currentBatches.length > 0 ? currentBatches[0].location : 'Dhaka';
            const coords = {
                'Dhaka': [23.8103, 90.4125],
                'Sylhet': [24.8949, 91.8687],
                'Chittagong': [22.3569, 91.7832],
                'Narayanganj': [23.6238, 90.5000],
                'Gazipur': [24.0022, 90.4264]
            };

            const center = coords[location] || coords['Dhaka'];
            map = L.map('risk-map').setView(center, 11);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);

            // Add farmer's own location (blue)
            const blueIcon = L.divIcon({
                html: '<div style="background: #208C9E; width: 30px; height: 30px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>',
                iconSize: [30, 30],
                className: ''
            });

            L.marker(center, { icon: blueIcon })
                .bindPopup('<b>‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶®</b><br>‡¶ù‡ßÅ‡¶Å‡¶ï‡¶ø: ‡¶Æ‡¶æ‡¶ù‡¶æ‡¶∞‡¶ø')
                .addTo(map);

            // Generate mock neighbors
            const riskColors = {
                'Low': '#15803D',
                'Medium': '#F59E0B',
                'High': '#C0152F'
            };

            const riskBangla = {
                'Low': '‡¶®‡¶ø‡¶Æ‡ßç‡¶®',
                'Medium': '‡¶Æ‡¶æ‡¶ù‡¶æ‡¶∞‡¶ø',
                'High': '‡¶â‡¶ö‡ßç‡¶ö'
            };

            const risks = ['Low', 'Low', 'Low', 'Low', 'Low', 'Medium', 'Medium', 'Medium', 'Medium', 'High', 'High', 'High'];

            for (let i = 0; i < 12; i++) {
                const lat = center[0] + (Math.random() - 0.5) * 0.1;
                const lon = center[1] + (Math.random() - 0.5) * 0.1;
                const risk = risks[i];
                const color = riskColors[risk];

                const icon = L.divIcon({
                    html: `<div style="background: ${color}; width: 20px; height: 20px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>`,
                    iconSize: [20, 20],
                    className: ''
                });

                const hours = Math.floor(Math.random() * 24) + 1;
                L.marker([lat, lon], { icon: icon })
                    .bindPopup(`
                        <div style="font-family: var(--font-family);">
                            <strong>‡¶´‡¶∏‡¶≤:</strong> ‡¶ß‡¶æ‡¶®<br>
                            <strong>‡¶ù‡ßÅ‡¶Å‡¶ï‡¶ø:</strong> ${riskBangla[risk]}<br>
                            <strong>‡¶∏‡¶∞‡ßç‡¶¨‡¶∂‡ßá‡¶∑ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü:</strong> ${hours} ‡¶ò‡¶£‡ßç‡¶ü‡¶æ ‡¶Ü‡¶ó‡ßá
                        </div>
                    `)
                    .addTo(map);
            }
        }

        // Voice interface
        function toggleVoice() {
            if (!recognition) {
                try {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    recognition = new SpeechRecognition();
                    recognition.lang = 'bn-BD';
                    recognition.continuous = false;
                    recognition.interimResults = false;

                    recognition.onresult = (event) => {
                        const transcript = event.results[0][0].transcript;
                        addMessage(transcript, 'user');
                        handleVoiceCommand(transcript);
                    };

                    recognition.onerror = (event) => {
                        console.error('Speech recognition error:', event.error);
                        document.getElementById('voice-status').textContent = 'Error: Please try again';
                        stopListening();
                    };

                    recognition.onend = () => {
                        stopListening();
                    };
                } catch (error) {
                    console.error('Speech recognition not supported:', error);
                    alert('Voice recognition not supported in this browser. Please use text chat.');
                    return;
                }
            }

            if (isListening) {
                recognition.stop();
                stopListening();
            } else {
                recognition.start();
                isListening = true;
                document.getElementById('voice-btn').classList.add('listening');
                document.getElementById('voice-status').textContent = 'Listening... Speak now';
                checkAndAwardBadge('weather_watcher');
            }
        }

        function stopListening() {
            isListening = false;
            document.getElementById('voice-btn').classList.remove('listening');
            document.getElementById('voice-status').textContent = 'Click microphone to speak';
        }

        function addMessage(text, type) {
            const container = document.getElementById('chat-messages');
            const message = document.createElement('div');
            message.className = `message message-${type}`;
            message.textContent = text;
            // If the message is a bot reply, copy the last user message's colors
            if (type === 'bot') {
                try {
                    const userMsgs = container.querySelectorAll('.message-user');
                    if (userMsgs && userMsgs.length > 0) {
                        const lastUser = userMsgs[userMsgs.length - 1];
                        const computed = window.getComputedStyle(lastUser);
                        // copy background and color so bot bubble matches input bubble
                        message.style.background = computed.backgroundColor;
                        message.style.color = computed.color;
                    }
                } catch (e) {
                    // ignore and fall back to default styling
                }
            }
            container.appendChild(message);
            container.scrollTop = container.scrollHeight;
        }

        function handleVoiceCommand(command) {
            const cmd = command.toLowerCase();
            let response = '';

            if (cmd.includes('‡¶Ü‡¶¨‡¶π‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ')) {
                response = '‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶Ü‡¶¨‡¶π‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ: ‡¶§‡¶æ‡¶™‡¶Æ‡¶æ‡¶§‡ßç‡¶∞‡¶æ ‡ß®‡ßÆ ‡¶°‡¶ø‡¶ó‡ßç‡¶∞‡¶ø ‡¶∏‡ßá‡¶≤‡¶∏‡¶ø‡¶Ø‡¶º‡¶æ‡¶∏, ‡¶Ü‡¶∞‡ßç‡¶¶‡ßç‡¶∞‡¶§‡¶æ ‡ß≠‡ß´%‡•§ ‡¶¨‡ßÉ‡¶∑‡ßç‡¶ü‡¶ø‡¶∞ ‡¶∏‡¶Æ‡ßç‡¶≠‡¶æ‡¶¨‡¶®‡¶æ ‡ß©‡ß¶%‡•§';
            } else if (cmd.includes('‡¶ß‡¶æ‡¶®')) {
                response = '‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ß‡¶æ‡¶® ‡¶Æ‡¶æ‡¶ù‡¶æ‡¶∞‡¶ø ‡¶ù‡ßÅ‡¶Å‡¶ï‡¶ø‡¶§‡ßá ‡¶Ü‡¶õ‡ßá‡•§ ‡¶®‡¶ø‡¶Ø‡¶º‡¶Æ‡¶ø‡¶§ ‡¶¨‡¶æ‡¶Ø‡¶º‡ßÅ‡¶ö‡¶≤‡¶æ‡¶ö‡¶≤ ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§';
            } else if (cmd.includes('‡¶ó‡ßÅ‡¶¶‡¶æ‡¶Æ')) {
                response = '‡¶ó‡ßÅ‡¶¶‡¶æ‡¶Æ‡ßá ‡¶Ü‡¶∞‡ßç‡¶¶‡ßç‡¶∞‡¶§‡¶æ ‡¶ï‡¶Æ‡¶æ‡¶§‡ßá ‡¶´‡ßç‡¶Ø‡¶æ‡¶® ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶è‡¶¨‡¶Ç ‡¶®‡¶ø‡¶Ø‡¶º‡¶Æ‡¶ø‡¶§ ‡¶™‡¶∞‡¶ø‡¶¶‡¶∞‡ßç‡¶∂‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§';
            } else if (cmd.includes('‡¶ï‡¶æ‡¶ü')) {
                response = '‡¶Ü‡¶ó‡¶æ‡¶Æ‡ßÄ ‡ß© ‡¶¶‡¶ø‡¶® ‡¶Ü‡¶¨‡¶π‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶≠‡¶æ‡¶≤‡ßã ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶´‡¶∏‡¶≤ ‡¶ï‡¶æ‡¶ü‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡¶®‡•§';
            } else {
                response = '‡¶¶‡ßÅ‡¶É‡¶ñ‡¶ø‡¶§, ‡¶Ü‡¶Æ‡¶ø ‡¶¨‡ßÅ‡¶ù‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶ø‡¶®‡¶ø‡•§ ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§';
            }

            setTimeout(() => {
                addMessage(response, 'bot');
                speak(response);
            }, 500);
        }

        function speak(text) {
            if (!synthesis) return;
            
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'bn-BD';
            utterance.rate = 0.9;
            synthesis.speak(utterance);
        }

        // Badges
        function updateBadges() {
            const allBadges = [
                { id: 'first_harvest', name: 'First Harvest Logged', nameBn: '‡¶™‡ßç‡¶∞‡¶•‡¶Æ ‡¶´‡¶∏‡¶≤ ‡¶®‡¶ø‡¶¨‡¶®‡ßç‡¶ß‡¶ø‡¶§', icon: 'üåæ' },
                { id: 'risk_expert', name: 'Risk Mitigated Expert', nameBn: '‡¶ù‡ßÅ‡¶Å‡¶ï‡¶ø ‡¶π‡ßç‡¶∞‡¶æ‡¶∏ ‡¶¨‡¶ø‡¶∂‡ßá‡¶∑‡¶ú‡ßç‡¶û', icon: 'üéØ' },
                { id: 'weather_watcher', name: 'Weather Watcher', nameBn: '‡¶Ü‡¶¨‡¶π‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶™‡ßç‡¶∞‡ßá‡¶Æ‡ßÄ', icon: 'üå§Ô∏è' },
                { id: 'pest_finder', name: 'Pest Finder', nameBn: '‡¶ï‡ßÄ‡¶ü‡¶™‡¶§‡¶ô‡ßç‡¶ó ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶¨‡ßá‡¶∞ ‡¶ï‡¶∞‡¶æ', icon: 'üîç' }
            ];

            const container = document.getElementById('badges-grid');
            container.innerHTML = allBadges.map(badge => {
                const isUnlocked = earnedBadges.includes(badge.id);
                return `
                    <div class="badge-card ${isUnlocked ? 'unlocked' : 'locked'}">
                        <div class="badge-icon">${badge.icon}</div>
                        <div class="badge-name">${currentLang === 'bn' ? badge.nameBn : badge.name}</div>
                    </div>
                `;
            }).join('');
        }

        function checkAndAwardBadge(badgeId) {
            if (!earnedBadges.includes(badgeId)) {
                earnedBadges.push(badgeId);
                appData.badges = earnedBadges;
                showToast('üèÜ New badge unlocked!');
                updateBadges();
                updateDashboard();
            }
        }

        function incrementInterventions() {
            interventionsCount++;
            appData.interventions = interventionsCount;
            
            if (interventionsCount >= 5) {
                checkAndAwardBadge('risk_expert');
            }
        }

        // Profile
        function updateProfile() {
            document.getElementById('profile-name').textContent = currentUser.name;
            document.getElementById('profile-email').textContent = currentUser.email;
            document.getElementById('profile-phone').textContent = currentUser.phone;
            document.getElementById('profile-lang').textContent = currentUser.lang === 'bn' ? '‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ' : 'English';
        }

        // Export data
        function exportData(format) {
            const data = {
                user: currentUser,
                batches: currentBatches,
                interventions: interventionsCount,
                badges: earnedBadges
            };

            if (format === 'json') {
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                downloadFile(blob, '‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶ï‡ßÉ‡¶∑‡¶ø-data.json');
            } else if (format === 'csv') {
                let csv = 'Crop Type,Weight,Harvest Date,Location,Storage Type,Risk,Status\n';
                currentBatches.forEach(batch => {
                    csv += `${batch.cropType},${batch.weight},${batch.harvestDate},${batch.location},${batch.storageType},${batch.risk},${batch.status}\n`;
                });
                const blob = new Blob([csv], { type: 'text/csv' });
                downloadFile(blob, '‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶ï‡ßÉ‡¶∑‡¶ø-batches.csv');
            }

            showToast('Data exported successfully!');
        }

        function downloadFile(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Logout
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                window.firebaseAuth.signOut().then(() => {
                    // Clear in-memory data
                    appData = {};
                    currentUser = null;
                    currentBatches = [];
                    earnedBadges = [];
                    interventionsCount = 0;
                    // Clear persisted data
                    try { localStorage.removeItem('amarkrishi_appData'); } catch (e) { }
                    document.getElementById('app-container').classList.add('hidden');
                    document.getElementById('landing-page').classList.remove('hidden');
                }).catch((error) => {
                    console.error('Logout error:', error);
                });
            }
        }

        // Toast notification
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.style.borderLeftColor = type === 'warning' ? 'var(--color-warning)' : 'var(--color-success)';
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // Initialize on load
        window.onload = () => {
            // Initialize in-memory storage
            if (!window.appData) {
                window.appData = appData;
            }
        };

        // Restore appData from localStorage if present
        (function restoreFromLocal() {
            try {
                const raw = localStorage.getItem('amarkrishi_appData');
                if (raw) {
                    const parsed = JSON.parse(raw);
                    window.appData = Object.assign({}, appData, parsed);
                    // restore currentUser and language if available
                    if (window.appData.user) {
                        currentUser = window.appData.user;
                        currentLang = window.appData.user.lang || currentLang;
                    }
                }
            } catch (e) {
                console.warn('Failed to restore local appData', e);
            }
        })();

        // Make functions globally available
        window.toggleLanguage = toggleLanguage;
        window.showAuthModal = showAuthModal;
        window.showPage = showPage;
        window.submitBatch = submitBatch;
        window.handleScannerUpload = handleScannerUpload;
        window.handlePestUpload = handlePestUpload;
        window.toggleVoice = toggleVoice;
        window.exportData = exportData;
        window.logout = logout;
    </script>
</body>
</html>
